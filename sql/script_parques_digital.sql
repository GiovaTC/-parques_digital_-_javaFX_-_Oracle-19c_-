-- ===============================
-- ? Script SQL - Parques Digital
-- ===============================

-- ? Eliminación de tablas previas (en orden por dependencias)
BEGIN
   EXECUTE IMMEDIATE 'DROP TABLE MOVES CASCADE CONSTRAINTS';
EXCEPTION
   WHEN OTHERS THEN
      IF SQLCODE != -942 THEN RAISE; END IF; -- ignora error si la tabla no existe
END;
/

BEGIN
   EXECUTE IMMEDIATE 'DROP TABLE GAME_SESSIONS CASCADE CONSTRAINTS';
EXCEPTION
   WHEN OTHERS THEN
      IF SQLCODE != -942 THEN RAISE; END IF;
END;
/

BEGIN
   EXECUTE IMMEDIATE 'DROP TABLE PLAYERS CASCADE CONSTRAINTS';
EXCEPTION
   WHEN OTHERS THEN
      IF SQLCODE != -942 THEN RAISE; END IF;
END;
/

-- ===============================
-- ? Creación de tablas
-- ===============================

-- Tabla de jugadores
CREATE TABLE PLAYERS (
  PLAYER_ID   NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
  USERNAME    VARCHAR2(100) NOT NULL UNIQUE,
  CREATED_AT  TIMESTAMP DEFAULT SYSTIMESTAMP
);

-- Tabla de sesiones de juego
CREATE TABLE GAME_SESSIONS (
  SESSION_ID       NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
  STARTED_AT       TIMESTAMP DEFAULT SYSTIMESTAMP,
  ENDED_AT         TIMESTAMP,
  WINNER_PLAYER_ID NUMBER,
  CONSTRAINT FK_GAMESESSION_WINNER FOREIGN KEY (WINNER_PLAYER_ID)
    REFERENCES PLAYERS(PLAYER_ID)
);

-- Tabla de movimientos realizados
CREATE TABLE MOVES (
  MOVE_ID     NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
  SESSION_ID  NUMBER NOT NULL,
  PLAYER_ID   NUMBER NOT NULL,
  MOVE_NUMBER NUMBER NOT NULL,
  FROM_POS    NUMBER,
  TO_POS      NUMBER,
  DICE_VALUE  NUMBER,
  CREATED_AT  TIMESTAMP DEFAULT SYSTIMESTAMP,

  CONSTRAINT FK_MOVES_SESSION FOREIGN KEY (SESSION_ID)
    REFERENCES GAME_SESSIONS(SESSION_ID),
  CONSTRAINT FK_MOVES_PLAYER FOREIGN KEY (PLAYER_ID)
    REFERENCES PLAYERS(PLAYER_ID)
);

-- ===============================
-- ? Datos iniciales
-- ===============================
INSERT INTO PLAYERS (USERNAME) VALUES ('jugador 1');
INSERT INTO PLAYERS (USERNAME) VALUES ('jugador 2');

COMMIT;
